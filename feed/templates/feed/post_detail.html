{% extends 'base.html' %}

{% block content %}
<style>
  .btn.dropdown-toggle::after {
  content: none; /* í™”ì‚´í‘œ ì œê±° */
  }
  .btn.dropdown-toggle::before {
  content: "..."; /* ì  ì„¸ ê°œ ì¶”ê°€ */
  font-size: 1.2rem; /* ì  ì„¸ ê°œ í¬ê¸° ì¡°ì • */
  color: #333; /* ì  ì„¸ ê°œ ìƒ‰ìƒ ì¡°ì • */
  }
  .edit-delete-buttons {
    position: absolute; /* ì ˆëŒ€ ìœ„ì¹˜ ì§€ì • */
    top: 35px; /* ìƒë‹¨ì—ì„œ n px ë–¨ì–´ì§„ ê³³ì— ìœ„ì¹˜ */
    right: 0px; /* ì˜¤ë¥¸ìª½ì—ì„œ n px ë–¨ì–´ì§„ ê³³ì— ìœ„ì¹˜ */
    z-index: 2; /* ì´ë¯¸ì§€ ìœ„ì— í‘œì‹œë˜ë„ë¡ z-index ì„¤ì • */
  }
  .btn {
  width: auto; /* ë²„íŠ¼ ë„ˆë¹„ë¥¼ ìë™ìœ¼ë¡œ ì„¤ì • */
  height: 25px; /* ë²„íŠ¼ ë†’ì´ 40px */
  line-height: 0px; /* í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
  background-color: white; /* ë²„íŠ¼ ë°°ê²½ìƒ‰ì„ í°ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
  }
  .edit-delete-buttons {
    float: right; /* ì˜¤ë¥¸ìª½ ì •ë ¬ */
    margin-top: -35px; /* ë²„íŠ¼ì„ ì¹´ë“œ ìƒë‹¨ ìª½ìœ¼ë¡œ ì˜®ê¸°ê¸° */
  }
  .custom-card {
    max-width: 600px; 
    margin: auto; 
  }
  .carousel-item .feed-image {
    object-fit: contain;
    width: 100%;
    height: 500px;
  }
  .carousel-item {
    transition: transform 1s ease, opacity 0.5s ease; 
  }
  .no-underline {
    text-decoration: none; 
  }
  .comment-container {
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 10px;
  }
  .comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
  }
  .comment-actions {
    display: flex;
    gap: 10px;
  }
  .comment-actions button {
    background-color: transparent;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 14px;
  }
  .carousel-control-next-icon,
  .carousel-control-prev-icon {
    filter: invert(1);
  }
</style>
<div class="container mt-5">
  <div class="card custom-card" style="position: relative;"> <!-- ìƒëŒ€ ìœ„ì¹˜ ì§€ì • -->
    {% if post.feed_images.all %}
      <div id="carouselExampleControls" class="carousel slide" data-bs-interval="false">
        <div class="carousel-inner">
          {% for image in post.feed_images.all %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
              <img src="{{ image.image.url }}" class="d-block w-100 feed-image" alt="...">
            </div>
          {% endfor %}
        </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
          </button>
        </div>
      {% endif %}
        

      <div class="card-body">
        <!-- ì•„ë˜ ì½”ë“œì—ì„œ post.user.id ë¥¼ post.user.pk ë¡œ ë³€ê²½ -->
        <h2><a href="{% url 'feed:view_user' pk=post.user.pk %}">{{ post.user.username }}</a></h2>
        <h2>{{ post.title }}</h2>
        <p class="mt-3">{{ post.body_text }}</p>
        
        <!-- ì¢‹ì•„ìš” ë²„íŠ¼ ìˆ˜ì • -->
        <a href="#" class="no-underline like-button" data-post="{{ post.id }}">
          {% if user in post.likes.all %}
            <span class="likes-count">â¤ï¸</span>
          {% else %}
            <span class="likes-count">ğŸ¤</span>
          {% endif %}
        </a>
        : <span class="likes-count">{{ post.likes.count }}</span>

        {% if post.content_type == 'review' and post.product %}
          <hr>
          <h5>ì œí’ˆ ë¦¬ë·°</h5>
          <p>ì œí’ˆëª…: {{ post.product.name }}</p>
          <p>íŒë§¤ì: {{ post.seller.username }}</p>
        {% endif %}
        
        <!-- ê²Œì‹œê¸€ì— ëŒ€í•œ ìˆ˜ì • ì‚­ì œ ë²„íŠ¼, ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í˜•íƒœë¡œ í‘œì‹œ -->
        {% if request.user == post.user or request.user.is_staff %}
        <div class="edit-delete-buttons">
          <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
            </button>            
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
              <li><a class="dropdown-item" href="{% url 'feed:post_edit' post.pk %}">ìˆ˜ì •</a></li>
              <li>
                <form action="{% url 'feed:post_delete' post.id %}" method="post" style="display: inline;">
                  {% csrf_token %}
                  <button type="submit" class="dropdown-item">ì‚­ì œ</button>
                </form>
              </li>
            </ul>
          </div>
        </div>
        {% endif %}



      <div class="card-footer">
        <h5>ëŒ“ê¸€</h5>
        {% for comment in post.comment_set.all %}
        <div class="comment-container">
          <div class="comment-header">
            <h6>{{ comment.user.username }}</h6>
            <div class="comment-actions">
              <p>{{ comment.created_at }}</p>
              {% if request.user == comment.user or request.user.is_staff %}
              <form action="{% url 'feed:comments_delete' comment.pk %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit">ì‚­ì œ</button>
              </form>
              {% endif %}
            </div>
          </div>
          <p>{{ comment.comment_text }}</p>
        </div>
        {% empty %}
        <p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
        
        <form action="{% url 'feed:comments_create' post.id %}" method="post">
          {% csrf_token %}
          {{ commentform }}
          <button type="submit" class="btn btn-primary">ì‘ì„±</button>
        </form>
      </div>
    </div>
</div>
<script>
// Djangoì—ì„œ ì œê³µí•˜ëŠ” CSRF í† í° ê°€ì ¸ì˜¤ê¸°
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

document.addEventListener("DOMContentLoaded", function(){
  const likeButtons = document.querySelectorAll('.like-button');
  
  likeButtons.forEach(button => {
    button.addEventListener('click', function(e){
      e.preventDefault();
      const postId = this.dataset.post; 
      console.log(csrftoken);

      fetch(`{%url "feed:like-content" post.id%}`, {
        method: 'POST',
        
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          'postId': postId,
        })
      })
      .then(response => response.json())
      .then(data => {
        const likeButton = this;
        const likesCountElement = likeButton.querySelector('.likes-count');
        likesCountElement.innerText = data.is_liked ? 'â¤ï¸' : 'ğŸ¤';
        likeButton.nextElementSibling.innerText = data.likes_count;
      })
      .catch((error) => {
        console.error('Error:', error);
      });
    });
  });
});
</script>
{% endblock %}
